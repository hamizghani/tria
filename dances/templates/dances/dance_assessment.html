<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Tria - Belajar Tarian Tradisional Indonesia</title>
    <link rel="icon" type="image/png" href="https://i.ibb.co.com/fY9F3RwF/tria.png" />
    <link rel="shortcut icon" type="image/png" href="https://i.ibb.co.com/fY9F3RwF/tria.png" />
    <style>
        :root {
            --tria-red: #e53935;
            --tria-orange: #ff9800;
            --tria-soft-bg: #fff7ec;
            --tria-orange-soft: #fff3e0;
            --tria-border: #f0e4d6;
            --tria-text: #222222;
            --tria-muted: #555555;
        }

        /* accent class for inline orange text - darker, richer gradient */
        .accent {
            background: linear-gradient(135deg, var(--tria-red), #e65100);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 800;
        }
    
        * {
            box-sizing: border-box;
        }
    
        body {
            background-color: var(--tria-soft-bg);
            color: var(--tria-text);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
                Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
            margin: 0;
            padding: 0;
        }
    
        a {
            text-decoration: none;
            color: inherit;
        }
    
        /* NAVBAR */
        .navbar {
            background-color: #ffffff;
            border-bottom: 1px solid #f3eee7;
            position: sticky;
            top: 0;
            z-index: 50;
            backdrop-filter: blur(10px);
        }
    
        .nav-inner {
            max-width: 1100px;
            margin: 0 auto;
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }
    
        .nav-brand {
            display: flex;
            align-items: center;
            gap: 0.6rem;
        }
    
        .nav-logo {
            height: 36px;
            width: 36px;
            object-fit: contain;
        }
    
        .nav-title {
            font-weight: 700;
            letter-spacing: 0.03em;
            font-size: 1.1rem;
        }
    
        .nav-links {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.95rem;
        }
    
        .nav-link {
            padding: 0.4rem 0.75rem;
            border-radius: 999px;
            transition: background-color 0.2s ease, color 0.2s ease, transform 0.1s ease;
        }
    
        .nav-link:hover {
            background-color: #fff1df;
            color: var(--tria-red);
            transform: translateY(-1px);
        }
    
        .nav-cta {
            background: linear-gradient(135deg, var(--tria-red), var(--tria-orange));
            color: #ffffff;
            font-weight: 600;
        }
    
        .nav-cta:hover {
            background: linear-gradient(135deg, #c62828, #fb8c00);
            color: #ffffff;
        }
    
        /* PAGE */
        .page {
            max-width: 1100px;
            margin: 2.5rem auto 3.5rem auto;
            padding: 0 1rem;
        }
    
        .section-title {
            font-size: 1.9rem;
            margin: 0 0 0.4rem 0;
            text-align: center;
            font-weight: 800;
            letter-spacing: -0.01em;
        }
    
        .section-subtitle {
            text-align: center;
            font-size: 0.98rem;
            color: var(--tria-muted);
            margin: 0 auto 2rem auto;
            max-width: 640px;
            line-height: 1.6;
        }

        /* VIDEO CONTAINER - Full width dengan border */
        .video-container {
            background-color: #ffffff;
            border-radius: 1.4rem;
            border: 1px solid var(--tria-border);
            overflow: hidden;
            box-shadow: 0 14px 30px rgba(0, 0, 0, 0.05);
            margin-bottom: 1.5rem;
        }

        video {
            width: 100%;
            height: 500px;
            object-fit: cover;
            display: block;
            background-color: #000000;
        }

        /* CONTROLS CONTAINER */
        .controls-container {
            background-color: #ffffff;
            border-radius: 1.4rem;
            border: 1px solid var(--tria-border);
            padding: 1.8rem 2rem;
            box-shadow: 0 14px 30px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1.5rem;
            flex-wrap: wrap;
        }

        .controls-left {
            display: flex;
            align-items: center;
            gap: 0.8rem;
        }

        .timer-display {
            font-size: 2rem;
            font-weight: 700;
            color: var(--tria-red);
            min-width: 120px;
            text-align: center;
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, var(--tria-orange-soft), #ffffff);
            border-radius: 12px;
            border: 2px solid var(--tria-border);
        }
    
        /* BUTTONS */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.85rem 2rem;
            border-radius: 999px;
            border: 1px solid transparent;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
    
        .btn-primary {
            background: linear-gradient(135deg, var(--tria-red), var(--tria-orange));
            color: #ffffff;
            box-shadow: 0 8px 18px rgba(229, 57, 53, 0.25);
        }
    
        .btn-primary:hover:not(:disabled) {
            background: linear-gradient(135deg, #c62828, #fb8c00);
            transform: translateY(-2px);
            box-shadow: 0 10px 24px rgba(229, 57, 53, 0.35);
        }
    
        .btn-outline {
            background-color: #ffffff;
            color: var(--tria-red);
            border-color: rgba(229, 57, 53, 0.3);
        }
    
        .btn-outline:hover:not(:disabled) {
            background-color: var(--tria-orange-soft);
            border-color: var(--tria-red);
            transform: translateY(-2px);
        }
    
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        /* LOADING OVERLAY */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            flex-direction: column;
            gap: 1rem;
        }

        .loading-text {
            font-size: 2rem;
            font-weight: 700;
            color: var(--tria-red);
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--tria-orange-soft);
            border-top: 5px solid var(--tria-red);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* COUNTDOWN OVERLAY */
        .countdown-overlay {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 5rem;
            font-weight: 800;
            color: var(--tria-red);
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            padding: 2rem 3rem;
            border-radius: 24px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        /* SUB-GERAKAN DISPLAY */
        .subgerakan-display-container {
            margin-bottom: 1.5rem;
        }

        .subgerakan-display {
            background: linear-gradient(135deg, #ffffff, #fffbf7);
            border-radius: 1.4rem;
            border: 2px solid var(--tria-border);
            padding: 2rem 2.2rem;
            box-shadow: 0 8px 24px rgba(229, 57, 53, 0.12);
            position: relative;
            overflow: hidden;
            transition: box-shadow 0.3s ease, transform 0.2s ease;
        }

        .subgerakan-display:hover {
            box-shadow: 0 12px 32px rgba(229, 57, 53, 0.16);
            transform: translateY(-2px);
        }

        .subgerakan-display::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--tria-red), var(--tria-orange));
        }

        .subgerakan-header-display {
            display: flex;
            align-items: center;
            gap: 1.2rem;
            margin-bottom: 1.2rem;
        }

        .subgerakan-badge {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--tria-red), var(--tria-orange));
            color: #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            font-weight: 800;
            flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(229, 57, 53, 0.3);
            position: relative;
            z-index: 1;
        }

        .subgerakan-title-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        .subgerakan-title-display {
            font-size: 1.5rem;
            font-weight: 800;
            margin: 0;
            color: var(--tria-text);
            letter-spacing: -0.01em;
            background: linear-gradient(135deg, var(--tria-red), #e65100);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            transition: all 0.3s ease;
        }

        .subgerakan-time-indicator {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--tria-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: color 0.3s ease;
        }

        .subgerakan-instruction {
            font-size: 1.05rem;
            color: var(--tria-text);
            line-height: 1.7;
            margin: 0;
            padding: 1.4rem 1.6rem;
            background: linear-gradient(135deg, var(--tria-orange-soft), #ffffff);
            border-radius: 1rem;
            border-left: 5px solid var(--tria-orange);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .subgerakan-instruction:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
        }

        /* MODAL DIALOG */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-dialog {
            background: #ffffff;
            border-radius: 1.4rem;
            padding: 2rem 2.5rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        .modal-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--tria-text);
            margin: 0 0 1rem 0;
        }

        .modal-message {
            font-size: 1rem;
            color: var(--tria-muted);
            line-height: 1.6;
            margin: 0 0 2rem 0;
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .modal-actions .btn {
            min-width: 120px;
        }
    
        @media (max-width: 768px) {
            video {
                height: 350px;
            }

            .controls-container {
                flex-direction: column;
                align-items: stretch;
            }

            .controls-left {
                flex-direction: column;
                width: 100%;
            }

            .btn {
                width: 100%;
            }

            .timer-display {
                width: 100%;
            }

            .countdown-overlay {
                font-size: 4rem;
                padding: 1.5rem 2.5rem;
            }

            .subgerakan-display {
                padding: 1.5rem 1.6rem;
            }

            .subgerakan-header-display {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.8rem;
            }

            .subgerakan-badge {
                width: 48px;
                height: 48px;
                font-size: 1.2rem;
            }

            .subgerakan-title-display {
                font-size: 1.3rem;
            }

            .subgerakan-instruction {
                font-size: 0.98rem;
                padding: 1.2rem 1.4rem;
            }

            .modal-dialog {
                padding: 1.5rem 2rem;
            }

            .modal-actions {
                flex-direction: column;
            }

            .modal-actions .btn {
                width: 100%;
            }
        }
    
        @media (max-width: 600px) {
            .page {
                padding-inline: 1rem;
            }

            video {
                height: 280px;
            }

            .subgerakan-display {
                padding: 1.4rem 1.5rem;
            }
        }
    </style>    
</head>
<body>
{% include 'partials/navbar.html' %}

<main class="page">
    <h1 class="section-title"><span class="accent">{{ dance.name }}</span> â€“ Mulai Asesmen</h1>
    <p class="section-subtitle">
        Gunakan kamera perangkatmu untuk merekam gerakan saat menarikan
        <strong>{{ dance.name }}</strong>. Tria akan membantu mengevaluasi hasilnya.
    </p>

    <div class="subgerakan-display-container">
        <div class="subgerakan-display">
            <div class="subgerakan-header-display">
                <span class="subgerakan-badge" id="subgerakanBadge">ðŸš€</span>
                <div class="subgerakan-title-wrapper">
                    <h3 class="subgerakan-title-display" id="subgerakanTitle">Mulai Asesmen anda</h3>
                    <span class="subgerakan-time-indicator" id="subgerakanTimeIndicator">Click Start</span>
                </div>
            </div>
            <p class="subgerakan-instruction" id="subgerakanInstruction">
                Klik tombol Start untuk memulai asesmen. Setelah mulai, instruksi akan berubah sesuai dengan gerakan yang sedang dilakukan.
            </p>
        </div>
    </div>

    <div class="video-container">
        <video id="video" autoplay playsinline></video>
    </div>

    <div class="controls-container">
        <div class="controls-left">
            <button id="startBtn" class="btn btn-primary">Start</button>
            <button id="finishBtn" class="btn btn-outline" disabled>Finish</button>
        </div>
        <div class="timer-display" id="timer">00:00</div>
    </div>
</main>

<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">Menganalisis Gerakmu...</div>
</div>

<div class="modal-overlay" id="modalOverlay">
    <div class="modal-dialog">
        <h3 class="modal-title">Konfirmasi Akhiri Asesmen</h3>
        <p class="modal-message" id="modalMessage">
            Penilaian belum selesai diuji. Apakah ingin mengakhiri karena tidak menyelesaikan pengujian?
        </p>
        <div class="modal-actions">
            <button class="btn btn-outline" id="modalCancel">Tidak</button>
            <button class="btn btn-primary" id="modalConfirm">Ya</button>
        </div>
    </div>
</div>

<script>
    // Get dance data from Django template
    const DANCE_ID = "{{ dance.id }}"; // Menangkap Dance ID
    const TOTAL_DURATION = parseInt("{{ dance.durasi_video|default:264 }}") || 264; // Duration in seconds
    const MAX_SUBGERAKAN = parseInt("{{ dance.max_subgerakan|default:15 }}") || 15;
    const SUBGERAKAN_DURATION = 18; // Each sub-gerakan is 18 seconds
    const DANCE_NAME = "{{ dance.name|default:'Tarian' }}";
    
    // Function to generate dance-specific instructions
    function generateDanceInstructions(danceName, numSubgerakan) {
        const instructions = [];
        const danceLower = danceName.toLowerCase();
        
        // Base instructions pool
        const baseInstructions = {
            start: [
                "Berdiri tegak dengan kaki rapat, tangan di samping badan. Siapkan postur tubuh dan fokus sebelum memulai gerakan.",
                "Posisi awal dengan postur yang benar, kedua kaki sejajar dan tangan dalam posisi siap.",
                "Mulai dengan posisi dasar, tubuh tegak dan seimbang, siap untuk memulai gerakan."
            ],
            hand: [
                "Angkat tangan kanan ke depan dengan telapak menghadap ke atas, gerakan lembut dan terkontrol.",
                "Gerakan tangan dengan pola melingkar, koordinasi antara tangan kanan dan kiri.",
                "Kedua tangan bergerak secara sinkron membentuk pola yang harmonis.",
                "Ayunkan tangan dengan irama yang konsisten, jaga kelenturan pergelangan tangan."
            ],
            foot: [
                "Melangkah dengan langkah yang terukur, jaga keseimbangan dan koordinasi.",
                "Gerakan kaki mengikuti pola dasar tarian, langkah maju, mundur, atau ke samping.",
                "Pindahkan berat badan dengan lembut sambil melangkah, jaga stabilitas tubuh."
            ],
            body: [
                "Putar badan dengan gerakan halus, pandangan mengikuti arah putaran.",
                "Gerakan tubuh mengikuti irama, ayunkan pinggul dengan lembut dan terkontrol.",
                "Koordinasi antara gerakan badan, tangan, dan kaki dengan harmonis."
            ],
            transition: [
                "Gerakan transisi yang menghubungkan bagian pertama dengan bagian berikutnya.",
                "Perubahan tempo dan intensitas gerakan, siapkan untuk bagian selanjutnya.",
                "Transisi yang mulus antara gerakan, jaga kontinuitas dan alur tarian."
            ],
            energetic: [
                "Bagian paling energik dari tarian, kombinasi semua elemen dengan tempo maksimal.",
                "Ekspresikan energi dan semangat melalui gerakan yang lebih dinamis dan penuh ekspresi.",
                "Tingkatkan intensitas gerakan, tunjukkan karakteristik khas tarian dengan penuh percaya diri."
            ],
            slow: [
                "Tempo mulai melambat, gerakan menjadi lebih tenang sebagai persiapan menuju penutupan.",
                "Redakan intensitas gerakan, fokus pada kelenturan dan keanggunan.",
                "Gerakan menjadi lebih halus dan terkontrol, persiapkan untuk bagian akhir."
            ],
            end: [
                "Kembali ke posisi tengah dengan gerakan lembut, mengumpulkan energi untuk pose akhir.",
                "Tahan pose akhir dengan sempurna, kedua tangan di depan dada, postur tegap menunjukkan penyelesaian tarian.",
                "Pose penutup yang elegan, tunjukkan penyelesaian tarian dengan percaya diri dan anggun."
            ]
        };
        
        // Dance-specific variations
        if (danceLower.includes('kecak')) {
            instructions.push("Berdiri dalam formasi, siapkan untuk gerakan khas Kecak dengan koordinasi kelompok.");
            instructions.push("Gerakan tangan dengan pola khas Kecak, koordinasi dengan suara 'cak'.");
            instructions.push("Langkah kaki mengikuti irama, jaga sinkronisasi dengan penari lain.");
        } else if (danceLower.includes('janger')) {
            instructions.push("Berdiri dengan postur yang ceria, siapkan untuk gerakan dinamis Janger.");
            instructions.push("Gerakan tangan yang lincah dan ceria, ekspresikan kegembiraan.");
            instructions.push("Langkah kaki yang energik, tunjukkan semangat muda dalam tarian.");
        } else if (danceLower.includes('bungong') || danceLower.includes('jeumpa')) {
            instructions.push("Berdiri dengan anggun, siapkan untuk gerakan yang melambangkan keindahan bunga.");
            instructions.push("Gerakan tangan yang lembut seperti kelopak bunga, ekspresikan keindahan.");
            instructions.push("Langkah kaki yang halus, jaga keanggunan dalam setiap gerakan.");
        } else if (danceLower.includes('lenggang') || danceLower.includes('nyai')) {
            instructions.push("Berdiri dengan postur anggun wanita, siapkan untuk gerakan lenggang yang khas.");
            instructions.push("Gerakan tangan yang lembut seperti kelopak bunga, ekspresikan keindahan.");
            instructions.push("Langkah kaki dengan pola khas lenggang, koordinasi dengan ayunan pinggul.");
        } else if (danceLower.includes('piring')) {
            instructions.push("Berdiri dengan memegang piring, siapkan untuk gerakan khas Tari Piring.");
            instructions.push("Gerakan tangan memutar piring dengan terampil, jaga keseimbangan piring.");
            instructions.push("Langkah kaki yang dinamis sambil mempertahankan piring tetap stabil.");
        } else if (danceLower.includes('serimpi')) {
            instructions.push("Berdiri dengan postur klasik, siapkan untuk gerakan lemah gemulai Serimpi.");
            instructions.push("Gerakan tangan yang sangat halus dan anggun, ekspresikan kelembutan.");
            instructions.push("Langkah kaki yang sangat pelan dan terkontrol, jaga keanggunan klasik.");
        } else if (danceLower.includes('saman')) {
            instructions.push("Berdiri dalam formasi, siapkan untuk gerakan cepat dan kompak Saman.");
            instructions.push("Gerakan tangan yang sangat cepat dan sinkron, koordinasi dengan penari lain.");
            instructions.push("Langkah kaki yang dinamis, jaga tempo cepat dan kompak.");
        } else if (danceLower.includes('reog')) {
            instructions.push("Berdiri dengan postur kuat, siapkan untuk gerakan energik Reog Ponorogo.");
            instructions.push("Gerakan tangan yang kuat dan dinamis, ekspresikan kekuatan karakter.");
            instructions.push("Langkah kaki yang tegas, tunjukkan karakteristik khas Reog.");
        } else if (danceLower.includes('topeng') || danceLower.includes('betawi')) {
            instructions.push("Berdiri dengan postur ceria, siapkan untuk gerakan khas Topeng Betawi.");
            instructions.push("Gerakan tangan yang lincah dan ekspresif, tunjukkan karakter topeng.");
            instructions.push("Langkah kaki yang dinamis, ekspresikan keceriaan khas Betawi.");
        } else if (danceLower.includes('gambyong')) {
            instructions.push("Berdiri dengan postur klasik Jawa, siapkan untuk gerakan anggun Gambyong.");
            instructions.push("Gerakan tangan yang sangat halus dan elegan, ekspresikan keanggunan klasik.");
            instructions.push("Langkah kaki yang pelan dan terkontrol, jaga kelembutan khas Gambyong.");
        } else {
            // Generic fallback
            instructions.push(...baseInstructions.start);
            instructions.push(...baseInstructions.hand);
            instructions.push(...baseInstructions.foot);
        }
        
        // Fill remaining with base instructions, shuffled for variety
        const allBase = [
            ...baseInstructions.start,
            ...baseInstructions.hand,
            ...baseInstructions.foot,
            ...baseInstructions.body,
            ...baseInstructions.transition,
            ...baseInstructions.energetic,
            ...baseInstructions.slow,
            ...baseInstructions.end
        ];
        
        // Shuffle array function
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }
        
        // Add shuffled base instructions to fill remaining slots
        const shuffledBase = shuffleArray(allBase);
        while (instructions.length < numSubgerakan) {
            instructions.push(...shuffledBase);
        }
        
        // Ensure first is always a start instruction and last is always an end instruction
        if (instructions.length > 0) {
            instructions[0] = baseInstructions.start[0];
        }
        if (instructions.length > 1) {
            instructions[instructions.length - 1] = baseInstructions.end[baseInstructions.end.length - 1];
        }
        
        return instructions.slice(0, numSubgerakan);
    }
    
    // Generate dance-specific instructions
    const danceInstructions = generateDanceInstructions(DANCE_NAME, MAX_SUBGERAKAN);
    
    // Dynamically generate sub-gerakan data based on duration
    const subGerakanData = [];
    for (let i = 0; i < MAX_SUBGERAKAN; i++) {
        const start = i * SUBGERAKAN_DURATION;
        const end = Math.min(start + SUBGERAKAN_DURATION, TOTAL_DURATION);
        if (start >= TOTAL_DURATION) break;
        
        subGerakanData.push({
            num: i + 1,
            start: start,
            end: end,
            title: `Sub Gerakan ${i + 1}`,
            instruction: danceInstructions[i] || "Lanjutkan gerakan dengan irama yang konsisten, jaga koordinasi dan ekspresi."
        });
    }

    const video = document.getElementById('video');
    const startBtn = document.getElementById('startBtn');
    const finishBtn = document.getElementById('finishBtn');
    const timerDisplay = document.getElementById('timer');
    const subgerakanBadge = document.getElementById('subgerakanBadge');
    const subgerakanTitle = document.getElementById('subgerakanTitle');
    const subgerakanInstruction = document.getElementById('subgerakanInstruction');
    const subgerakanTimeIndicator = document.getElementById('subgerakanTimeIndicator');
    const modalOverlay = document.getElementById('modalOverlay');
    const modalCancel = document.getElementById('modalCancel');
    const modalConfirm = document.getElementById('modalConfirm');
    
    let stream;
    let timerInterval;
    let seconds = 0;
    let currentSubGerakan = null;
    let stoppedAtGerakan = null;

    // Helper function to format time (seconds to mm:ss)
    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins.toString().padStart(1, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    // Function to update sub-gerakan display based on elapsed time
    function updateSubGerakanDisplay(elapsedSeconds) {
        // Check if completed all
        if (elapsedSeconds >= TOTAL_DURATION) {
            const lastGerakan = subGerakanData[subGerakanData.length - 1];
            subgerakanBadge.textContent = MAX_SUBGERAKAN.toString();
            subgerakanTitle.textContent = 'Selamat! Asesmen Selesai';
            subgerakanInstruction.textContent = 'Anda telah menyelesaikan semua sub-gerakan. Klik Finish untuk melihat hasil.';
            subgerakanTimeIndicator.textContent = `${formatTime(lastGerakan.start)} - ${formatTime(TOTAL_DURATION)}`;
            return;
        }

        // Find the current sub-gerakan based on elapsed time
        const activeGerakan = subGerakanData.find(gerakan => 
            elapsedSeconds >= gerakan.start && elapsedSeconds < gerakan.end
        );

        // If no match found (shouldn't happen, but handle edge cases)
        if (!activeGerakan) {
            // Find the last gerakan that hasn't started yet, or default to first
            const nextGerakan = subGerakanData.find(gerakan => elapsedSeconds < gerakan.start) || subGerakanData[0];
            if (currentSubGerakan?.num !== nextGerakan.num) {
                currentSubGerakan = nextGerakan;
                subgerakanBadge.textContent = nextGerakan.num;
                subgerakanTitle.textContent = `Lakukan ${nextGerakan.title}`;
                subgerakanInstruction.textContent = nextGerakan.instruction;
                subgerakanTimeIndicator.textContent = `${formatTime(nextGerakan.start)} - ${formatTime(nextGerakan.end)}`;
            }
            return;
        }

        // Update if changed
        if (!currentSubGerakan || currentSubGerakan.num !== activeGerakan.num) {
            currentSubGerakan = activeGerakan;
            subgerakanBadge.textContent = activeGerakan.num;
            subgerakanTitle.textContent = `Lakukan ${activeGerakan.title}`;
            subgerakanInstruction.textContent = activeGerakan.instruction;
            subgerakanTimeIndicator.textContent = `${formatTime(activeGerakan.start)} - ${formatTime(activeGerakan.end)}`;
        }
    }

    // Function to get current sub-gerakan number based on elapsed time
    function getCurrentGerakanNumber(elapsedSeconds) {
        if (elapsedSeconds >= TOTAL_DURATION) {
            return MAX_SUBGERAKAN; // Completed
        }
        const activeGerakan = subGerakanData.find(gerakan => 
            elapsedSeconds >= gerakan.start && elapsedSeconds < gerakan.end
        );
        return activeGerakan ? activeGerakan.num : null;
    }

    // Modal handlers
    modalCancel.addEventListener('click', () => {
        modalOverlay.classList.remove('show');
    });

    modalConfirm.addEventListener('click', async () => {
        modalOverlay.classList.remove('show');
        await finishAssessment(true);
    });

    startBtn.addEventListener('click', countdownAndStart);

    async function countdownAndStart() {
        const countdownDiv = document.createElement('div');
        countdownDiv.className = 'countdown-overlay';
        document.body.appendChild(countdownDiv);

        for (let i = 3; i > 0; i--) {
            countdownDiv.textContent = i;
            await new Promise(resolve => setTimeout(resolve, 1000));
        }

        document.body.removeChild(countdownDiv);

        try {
            stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
            video.srcObject = stream;
            startBtn.disabled = true;
            finishBtn.disabled = false;

            // Start timer
            seconds = 0;
            timerDisplay.textContent = '00:00';
            currentSubGerakan = null;
            
            // Update initial sub-gerakan display immediately
            updateSubGerakanDisplay(0);
            
            timerInterval = setInterval(() => {
                seconds++;
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                timerDisplay.textContent = 
                    `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                
                // Update sub-gerakan display every second
                updateSubGerakanDisplay(seconds);
            }, 1000);

        } catch (err) {
            alert('Could not access camera: ' + err);
        }
    }

    finishBtn.addEventListener('click', () => {
        // Check if finished early (before 4:24 = 264 seconds)
        if (seconds < TOTAL_DURATION) {
            // Show confirmation modal for early finish
            const currentGerakanNum = getCurrentGerakanNumber(seconds);
            stoppedAtGerakan = currentGerakanNum || 1;
            modalOverlay.classList.add('show');
        } else {
            // Completed all, finish normally
            finishAssessment(false);
        }
    });

    async function finishAssessment(isEarlyFinish) {
        // Stop camera
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
        }
        video.srcObject = null;

        // Stop timer
        if (timerInterval) {
            clearInterval(timerInterval);
        }

        // Determine which gerakan was completed
        let completedGerakan = MAX_SUBGERAKAN; // Default to all completed
        if (isEarlyFinish && stoppedAtGerakan !== null) {
            completedGerakan = stoppedAtGerakan;
        } else if (isEarlyFinish) {
            completedGerakan = getCurrentGerakanNumber(seconds) || 1;
        }

        // Show loading overlay
        document.getElementById("loadingOverlay").style.display = "flex";

        try {
            // LOGIC PERUBAHAN API URL DI SINI
            let apiUrl = "https://web-production-cd198.up.railway.app/api/givescore";
            
            // Cek jika Dance ID adalah 3, ubah endpoint
            if (DANCE_ID == "3") {
                apiUrl = "https://web-production-46d4.up.railway.app/api/bungong";
            }

            const response = await fetch(apiUrl);
            const result = await response.json();

            // Store result and completion info
            sessionStorage.setItem("dance_result_api", JSON.stringify(result));
            sessionStorage.setItem("completed_gerakan", completedGerakan.toString());
            sessionStorage.setItem("is_early_finish", isEarlyFinish.toString());
            sessionStorage.setItem("max_subgerakan", MAX_SUBGERAKAN.toString());

            window.location.href = "{% url 'dances:dance_result' dance.id %}";
        } catch (error) {
            alert("Failed to get score from API: " + error);
            document.getElementById("loadingOverlay").style.display = "none";
        }
    }
</script>

</body>
</html>